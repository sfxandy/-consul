---
# 0. Required input: nomad_service_user
- name: "Nomad | Ensure nomad_service_user is defined"
  ansible.builtin.assert:
    that:
      - nomad_service_user is defined
      - nomad_service_user | length > 0
    fail_msg: >
      'nomad_service_user' must be provided
      (e.g. via -e nomad_service_user=root or set in the play/inventory).

# 1. Default group to user if not set
- name: "Nomad | Default nomad_service_group to nomad_service_user"
  ansible.builtin.set_fact:
    nomad_service_group: "{{ nomad_service_group | default(nomad_service_user, true) }}"

# 2. Verify service user exists (no creation)
- name: "Nomad | Lookup service user in passwd database"
  ansible.builtin.getent:
    database: passwd
    key: "{{ nomad_service_user }}"
  register: nomad_service_getent

- name: "Nomad | Fail if service user does not exist"
  ansible.builtin.fail:
    msg: >
      Service user '{{ nomad_service_user }}' does not exist in passwd/NSS.
      Create it outside this role, then re-run.
  when: >
    nomad_service_getent.passwd is not defined or
    nomad_service_getent.passwd[nomad_service_user] is not defined

# 3. Derive service_home for non-root (unless explicitly overridden)
- name: "Nomad | Set service_home from passwd entry (non-root)"
  ansible.builtin.set_fact:
    nomad_service_home: "{{ nomad_service_getent.passwd[nomad_service_user][4] }}"
  when:
    - nomad_service_user != "root"
    - (nomad_service_home | length) == 0

- name: "Nomad | Fail if non-root service_home is empty"
  ansible.builtin.fail:
    msg: >
      Could not determine home directory for non-root nomad_service_user='{{ nomad_service_user }}'.
      Set 'nomad_service_home' explicitly when calling the role.
  when:
    - nomad_service_user != "root"
    - (nomad_service_home | length) == 0

# 4. Compute config/data dirs from who runs Nomad
- name: "Nomad | Compute config and data dirs"
  ansible.builtin.set_fact:
    nomad_config_dir: >-
      {{ (nomad_service_user == 'root')
         | ternary('/etc/nomad.d', nomad_service_home ~ '/.config/nomad.d') }}
    nomad_data_dir: >-
      {{ (nomad_service_user == 'root')
         | ternary('/var/lib/nomad', nomad_service_home ~ '/.local/share/nomad') }}

# 5. Verify task users (root-run mode only; no creation)
- name: "Nomad | Check that task users exist (root-run mode only)"
  ansible.builtin.getent:
    database: passwd
    key: "{{ item }}"
  loop: "{{ nomad_task_users }}"
  register: nomad_task_getent
  when:
    - nomad_service_user == "root"
    - nomad_task_users | length > 0

- name: "Nomad | Fail if any task user does not exist"
  ansible.builtin.fail:
    msg: >
      Task user '{{ item.item }}' does not exist in passwd/NSS.
      Create it outside this role or remove it from nomad_task_users.
  loop: "{{ nomad_task_getent.results | default([]) }}"
  when:
    - nomad_service_user == "root"
    - nomad_task_users | length > 0
    - (item.passwd is not defined or item.passwd[item.item] is not defined)

# 6. Create dirs and install Nomad binary
- name: "Nomad | Create config and data directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ nomad_service_user }}"
    group: "{{ nomad_service_group }}"
    mode: "0750"
  loop:
    - "{{ nomad_config_dir }}"
    - "{{ nomad_data_dir }}"

- name: "Nomad | Download archive"
  ansible.builtin.get_url:
    url: "{{ nomad_download_base_url }}/{{ nomad_version }}/nomad_{{ nomad_version }}_{{ nomad_arch }}.zip"
    dest: "/tmp/nomad_{{ nomad_version }}_{{ nomad_arch }}.zip"
    mode: "0644"

- name: "Nomad | Unarchive"
  ansible.builtin.unarchive:
    src: "/tmp/nomad_{{ nomad_version }}_{{ nomad_arch }}.zip"
    dest: "/tmp/nomad_{{ nomad_version }}"
    remote_src: true
    creates: "/tmp/nomad_{{ nomad_version }}/nomad"

- name: "Nomad | Install binary"
  ansible.builtin.copy:
    src: "/tmp/nomad_{{ nomad_version }}/nomad"
    dest: "{{ nomad_install_dir }}/nomad"
    mode: "0755"
    remote_src: true
  notify: restart nomad

# 7. Config files (base / server / client)
- name: "Nomad | Render base config (global settings)"
  ansible.builtin.template:
    src: "nomad-base.hcl.j2"
    dest: "{{ nomad_config_dir }}/nomad-base.hcl"
    owner: "{{ nomad_service_user }}"
    group: "{{ nomad_service_group }}"
    mode: "0640"
  notify: restart nomad

- name: "Nomad | Render server config"
  ansible.builtin.template:
    src: "nomad-server.hcl.j2"
    dest: "{{ nomad_config_dir }}/nomad-server.hcl"
    owner: "{{ nomad_service_user }}"
    group: "{{ nomad_service_group }}"
    mode: "0640"
  when: nomad_is_server
  notify: restart nomad

- name: "Nomad | Render client config"
  ansible.builtin.template:
    src: "nomad-client.hcl.j2"
    dest: "{{ nomad_config_dir }}/nomad-client.hcl"
    owner: "{{ nomad_service_user }}"
    group: "{{ nomad_service_group }}"
    mode: "0640"
  when: nomad_client_enabled
  notify: restart nomad

# 8. Systemd service
- name: "Nomad | Install systemd unit"
  ansible.builtin.template:
    src: "nomad.service.j2"
    dest: "/etc/systemd/system/{{ nomad_service_name }}.service"
    mode: "0644"
  notify:
    - daemon-reload
    - restart nomad

- name: "Nomad | Ensure service enabled and started"
  ansible.builtin.systemd:
    name: "{{ nomad_service_name }}"
    enabled: true
    state: started

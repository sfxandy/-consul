%% svc-handler v2.1 PUT sequence (Mermaid)
sequenceDiagram
    autonumber
    participant C as Client
    participant A as API Server
    participant KV as Consul KV
    participant S as Consul Sessions
    participant CE as Consul Config Entries

    C->>A: PUT /services/{name} + JSON
    A->>A: Validate payload & name
    alt Invalid payload/name
        A-->>C: 422 Unprocessable Entity
    else Valid
        A->>KV: Put desired JSON (svc-handler/desired/part/ns/name)
        alt KV write fails
            A-->>C: 502 Bad Gateway (step="kv.put")
        else KV ok
            A->>S: Create session (TTL=LOCK_TTL)
            A->>KV: Acquire lock (svc-handler/locks/part/ns/name, session)
            alt Lock held by another worker
                A-->>C: 409 Conflict (operation in progress)
                A->>S: Destroy session
            else Lock acquired
                A->>CE: Set ServiceDefaults(name, protocol)
                alt Defaults upsert fails
                    A-->>C: 502 (apply, step="service-defaults")
                else Defaults ok
                    A->>CE: Upsert TerminatingGateway(tgwService, link=name, meta=routing/*)
                    alt TGW upsert fails
                        A-->>C: 502 (apply, step="terminating-gateway")
                    else TGW ok
                        opt Router provided
                            A->>CE: Set ServiceRouter(name, prefix,retries)
                            alt Router upsert fails
                                A-->>C: 502 (apply, step="service-router")
                            end
                        end
                        A->>CE: Get ServiceDefaults(name) (RequireConsistent)
                        A->>CE: Get TerminatingGateway(tgwService) (RequireConsistent)
                        opt Router provided
                            A->>CE: Get ServiceRouter(name) (RequireConsistent)
                        end
                        alt Verify fails
                            A-->>C: 502 (verify)
                        else Verified
                            A->>KV: Release lock
                            A->>S: Destroy session
                            A-->>C: 200 OK {"status":"applied","observed":{...}}
                        end
                    end
                end
            end
        end
    end
```



%% svc-handler v2.1.1 — PUT /services/{name} (explicit config-entry rendering, KV, sessions)
sequenceDiagram
    autonumber
    participant C as Client
    participant A as API Server
    participant KV as Consul KV
    participant S as Consul Sessions
    participant CE as Consul Config Entries

    Note over A: Env: CONSUL_PARTITION=default, CONSUL_NAMESPACE=default, TGW_SERVICE_NAME=tgw-1
    C->>A: PUT /services/{name} + JSON payload
    A->>A: Parse JSON → spec; force spec.Name = {name}
    A->>A: Validate (name, routing.host/port, connect.protocol, router.*)

    alt Invalid payload/name
        A-->>C: 422 Unprocessable Entity
        deactivate A
    else Valid
        Note over A,KV: Desired-state write (idempotent)
        A->>KV: PUT key=svc-handler/desired/<part>/<ns>/{name} value=spec(JSON)
        alt KV write fails (ACL/network/quorum)
            A-->>C: 502 Bad Gateway (step="kv.put")
        else KV ok
            Note over A,S: Per-service lock via Consul Session
            A->>S: Session.Create(TTL=LOCK_TTL, Behavior=delete, Name="svc-handler:{name}")
            A->>KV: KV.Acquire key=svc-handler/locks/<part>/<ns>/{name} value={hostname}, session={sid}
            alt Lock already held
                A-->>C: 409 Conflict (operation in progress)
                A->>S: Session.Destroy({sid})
            else Lock acquired
                par Session renew
                    A--)S: Session.Renew({sid}) every TTL/2 until done
                and Render config entries (from spec)
                    A->>A: Build ServiceDefaults(name, protocol, timeouts, meta/labels)
                    A->>A: Build ServiceResolver(name)  %% (optional baseline; subsets/failover later)
                    A->>A: Build ServiceRouter(name, prefix,retries) %% only if router provided
                    A->>A: Build TGW mapping (tgw-1 ← name → routing.host:port + TLS/mTLS refs)
                end

                %% ---- APPLY (ordered, idempotent upserts) ----
                A->>CE: Set ServiceDefaults(name, …)
                alt Defaults upsert fails
                    A-->>C: 502 (apply, step="service-defaults")
                else Defaults ok
                    A->>CE: Set ServiceResolver(name, …)  %% noop if minimal
                    alt Resolver upsert fails
                        A-->>C: 502 (apply, step="service-resolver")
                    else Resolver ok
                        opt Router provided
                            A->>CE: Set ServiceRouter(name, prefix,retries)
                            alt Router upsert fails
                                A-->>C: 502 (apply, step="service-router")
                            end
                        end
                        A->>CE: Upsert TerminatingGateway(tgw-1, link=name, meta=routing/*,tls/*)
                        alt TGW upsert fails
                            A-->>C: 502 (apply, step="terminating-gateway")
                        else TGW ok
                            %% ---- VERIFY (consistent reads) ----
                            A->>CE: Get ServiceDefaults(name) [RequireConsistent]
                            A->>CE: Get ServiceResolver(name) [RequireConsistent]
                            opt Router provided
                                A->>CE: Get ServiceRouter(name) [RequireConsistent]
                            end
                            A->>CE: Get TerminatingGateway(tgw-1) [RequireConsistent]
                            alt Any component missing or mismatched
                                A-->>C: 502 (verify)
                            else Verified
                                Note over A,KV,S: Teardown lock
                                A->>KV: KV.Release key=svc-handler/locks/<part>/<ns>/{name}, session={sid}
                                A->>S: Session.Destroy({sid})
                                A-->>C: 200 OK {"name": "{name}", "status":"applied","observed":{defaults:"ok",resolver:"ok",router:"ok|skipped",tgw:"ok"}}
                            end
                        end
                    end
                end
            end
        end
    end

    %% ---- NOTES / ANNOTATIONS ----
    Note over A: Rendering rules\n• Defaults.Protocol ← spec.connect.protocol (default tcp)\n• Defaults.Timeouts ← spec.connect.timeouts (if provided)\n• Resolver baseline (optional now; subsets/failover later)\n• Router only when spec.router present\n• TGW mapping encodes routing.host:port and tls refs as meta for TGW/SDS
    Note over KV: Keys used\n• desired: svc-handler/desired/<part>/<ns>/{name}\n• locks:   svc-handler/locks/<part>/<ns>/{name}
    Note over S: Session lifecycle\n• Create → Acquire → Renew (TTL/2) → Release → Destroy\n• On crash: TTL expiry auto-releases the lock

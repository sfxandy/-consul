sequenceDiagram
    autonumber
    participant C as Client
    participant A as API Server
    participant KV as Consul KV
    participant S as Consul Sessions
    participant CE as Consul Config Entries

    Note over A: Env uses CONSUL_PARTITION and CONSUL_NAMESPACE defaults to default

    C->>A: PUT /services name with JSON payload
    A->>A: Parse JSON to spec and set name from path
    A->>A: Build objects Defaults Resolver Router optional TGW mapping
    A->>KV: KV put desired base svc-handler/desired/part/ns/name base.json with normalized payload

    A->>S: Session create with TTL
    A->>KV: KV acquire lock svc-handler/locks/part/ns/name using session

    %% 1 Defaults write and verify
    A->>CE: Upsert ServiceDefaults by name
    A->>CE: Read ServiceDefaults consistent
    A->>A: Capture resource id for Defaults
    A->>KV: KV put svc-handler/desired/part/ns/name defaults.json with object and resource id

    %% 2 Resolver write and verify
    A->>CE: Upsert ServiceResolver by name
    A->>CE: Read ServiceResolver consistent
    A->>A: Capture resource id for Resolver
    A->>KV: KV put svc-handler/desired/part/ns/name resolver.json with object and resource id

    %% 3 Router write and verify only if present
    opt Router present
        A->>CE: Upsert ServiceRouter by name
        A->>CE: Read ServiceRouter consistent
        A->>A: Capture resource id for Router
        A->>KV: KV put svc-handler/desired/part/ns/name router.json with object and resource id
    end

    %% 4 TGW write and verify
    A->>CE: Upsert TerminatingGateway link for name
    A->>CE: Read TerminatingGateway consistent
    A->>A: Capture resource id or version for TGW
    A->>KV: KV put svc-handler/desired/part/ns/name tgw.json with object and resource id

    %% Discovery snapshot
    A->>CE: Read Defaults Resolver Router optional TGW consistent
    A->>KV: KV put svc-handler/observed/part/ns/name observed.json with ids and summary

    %% Teardown and reply
    A->>KV: KV release lock svc-handler/locks/part/ns/name using session
    A->>S: Session destroy
    A-->>C: 200 OK status applied with observed summary

    Note over A: Idempotent because deterministic keys upserts and verify after each write
    Note over S: Session ensures single writer and TTL auto releases on crash

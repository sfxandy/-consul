---
# Rolling restart after rendering ACL overlay so all instances pick up ACLs
# Includes per-host ACL enablement checks (HTTP status code probe).

# Derive probe URL and curl TLS args (works for HTTP/HTTPS)
- name: ACL probe | derive URL and curl args
  set_fact:
    _acl_probe_url: >-
      {{
        (consul_api_use_https | bool)
        | ternary('https://127.0.0.1:' ~ consul_https_port ~ '/v1/acl/bootstrap',
                  'http://127.0.0.1:8500/v1/acl/bootstrap')
      }}
    _acl_probe_tls: >-
      {{
        (consul_api_use_https | bool)
        | ternary('--cacert ' ~ consul_tls_ca_path, '')
      }}

# Ensure cluster currently has a leader before starting the roll
- name: Wait for Raft leader (pre-check)
  command: >
    podman exec
    {{ consul_server_container }}
    sh -lc "consul operator raft list-peers | tail -n +2 | awk '{print $3}' | grep -iq '^leader$'"
  register: _leader_pre
  retries: 40
  delay: 3
  until: _leader_pre.rc == 0
  run_once: true
  delegate_to: "{{ consul_api_host }}"

# Restart SERVERS one-by-one
- name: Rolling restart | servers
  include_tasks: restart_server_one.yml
  loop: "{{ groups['consul_hosts'] }}"
  loop_control:
    loop_var: tgt

# Restart AGENTS one-by-one
- name: Rolling restart | agents
  include_tasks: restart_agent_one.yml
  loop: "{{ groups['consul_hosts'] }}"
  loop_control:
    loop_var: tgt



---
# Expects: tgt, compose_repo_root, compose_repo_compose, consul_server_container,
#          consul_api_host, _acl_probe_url, _acl_probe_tls

- name: Server {{ tgt }} | stop
  command: podman-compose -f {{ compose_repo_compose }} stop consul-server
  args:
    chdir: "{{ compose_repo_root }}"
  delegate_to: "{{ tgt }}"
  register: _stop_srv
  failed_when: false
  changed_when: _stop_srv.rc == 0

- name: Server {{ tgt }} | up
  command: podman-compose -f {{ compose_repo_compose }} up -d consul-server
  args:
    chdir: "{{ compose_repo_root }}"
  delegate_to: "{{ tgt }}"
  register: _up_srv
  changed_when: _up_srv.rc == 0

# After each server restart, ensure a leader exists again
- name: Server {{ tgt }} | wait for leader post-restart
  command: >
    podman exec
    {{ consul_server_container }}
    sh -lc "consul operator raft list-peers | tail -n +2 | awk '{print $3}' | grep -iq '^leader$'"
  register: _leader_after_srv
  retries: 40
  delay: 3
  until: _leader_after_srv.rc == 0
  run_once: true
  delegate_to: "{{ consul_api_host }}"

# Probe ACLs on this server (inside its container)
- name: Server {{ tgt }} | check ACL state (HTTP code)
  command: >
    podman exec {{ consul_server_container }} sh -lc
    "curl -s -o /dev/null -w '%{http_code}' {{ _acl_probe_tls }} {{ _acl_probe_url }}"
  delegate_to: "{{ tgt }}"
  register: _srv_acl
  changed_when: false

- name: Server {{ tgt }} | assert ACLs enabled
  assert:
    that:
      - (_srv_acl.stdout | trim) != '404'
    fail_msg: >-
      ACLs appear DISABLED on {{ tgt }} (HTTP {{ _srv_acl.stdout | trim }} from /v1/acl/bootstrap).
      Ensure 90-acl.hcl is present and the container was restarted cleanly.


---
# Expects: tgt, compose_repo_root, compose_repo_compose, consul_client_container,
#          _acl_probe_url, _acl_probe_tls

- name: Agent {{ tgt }} | stop
  command: podman-compose -f {{ compose_repo_compose }} stop consul-agent
  args:
    chdir: "{{ compose_repo_root }}"
  delegate_to: "{{ tgt }}"
  register: _stop_cli
  failed_when: false
  changed_when: _stop_cli.rc == 0

- name: Agent {{ tgt }} | up
  command: podman-compose -f {{ compose_repo_compose }} up -d consul-agent
  args:
    chdir: "{{ compose_repo_root }}"
  delegate_to: "{{ tgt }}"
  register: _up_cli
  changed_when: _up_cli.rc == 0

# Light sanity: agent is responsive
- name: Agent {{ tgt }} | consul info check
  command: podman exec {{ consul_client_container }} consul info
  delegate_to: "{{ tgt }}"
  register: _cli_info
  retries: 20
  delay: 2
  until: _cli_info.rc == 0

# Probe ACLs on this agent (inside its container)
- name: Agent {{ tgt }} | check ACL state (HTTP code)
  command: >
    podman exec {{ consul_client_container }} sh -lc
    "curl -s -o /dev/null -w '%{http_code}' {{ _acl_probe_tls }} {{ _acl_probe_url }}"
  delegate_to: "{{ tgt }}"
  register: _cli_acl
  changed_when: false

- name: Agent {{ tgt }} | assert ACLs enabled
  assert:
    that:
      - (_cli_acl.stdout | trim) != '404'
    fail_msg: >-
      ACLs appear DISABLED on agent at {{ tgt }} (HTTP {{ _cli_acl.stdout | trim }} from /v1/acl/bootstrap).
      Ensure 90-acl.hcl is present and the container was restarted cleanly.


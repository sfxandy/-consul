---
# Persist the agent token values from Podman secrets into Consul agents

- name: Persist agent token in SERVER
  command: >
    podman exec {{ consul_server_container }} sh -lc
    'consul acl set-agent-token agent  "$(cat /run/secrets/{{ podman_secret_target_server }})" &&
     consul acl set-agent-token default "$(cat /run/secrets/{{ podman_secret_target_server }})"'
  changed_when: true

- name: Persist agent token in CLIENT
  command: >
    podman exec {{ consul_client_container }} sh -lc
    'consul acl set-agent-token agent  "$(cat /run/secrets/{{ podman_secret_target_client }})" &&
     consul acl set-agent-token default "$(cat /run/secrets/{{ podman_secret_target_client }})"'
  changed_when: true

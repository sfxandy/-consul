---
# Host-side API calls (no container exec); idempotent PUT-by-name upserts.

- name: Compute base URL, token and TLS params
  set_fact:
    _api_base: >-
      {{
        (consul_api_use_https | bool)
        | ternary('https://127.0.0.1:' ~ consul_https_port|string,
                  'http://127.0.0.1:8500')
      }}
    _gmt_eff: "{{ hostvars[consul_api_host].consul_mgmt_token_eff | default(consul_mgmt_token_eff_global) }}"
    _uri_validate: "{{ (consul_api_use_https | bool) | ternary(true, false) }}"
  run_once: true
  delegate_to: "{{ consul_api_host }}"

- name: Assert policies + token available
  assert:
    that:
      - consul_policies | length > 0
      - (_gmt_eff | length) > 0
      - consul_policies | map(attribute='file') | map('string') | list | length == (consul_policies | length)
    fail_msg: "Need consul_policies with valid 'file' paths and a GMT (bootstrap first or provide CONSUL_HTTP_TOKEN)."
  run_once: true
  delegate_to: "{{ consul_api_host }}"

# Upsert all policies via loop
- name: Upsert policies (PUT /v1/acl/policy/name/{name})
  uri:
    url: "{{ _api_base }}/v1/acl/policy/name/{{ item.name | urlencode }}"
    method: PUT
    headers:
      X-Consul-Token: "{{ _gmt_eff }}"
    body_format: json
    body:
      Name: "{{ item.name }}"
      Rules: "{{ _rules }}"
      Description: "{{ item.description | default(omit) }}"
    return_content: false
    status_code: [200]         # create/update both return 200 for PUT-by-name
    validate_certs: "{{ _uri_validate }}"
    # ca_path: "{{ consul_tls_ca_host_path | default(omit) }}"  # set if you pin a CA on host
  vars:
    _rules: "{{ lookup('file', item.file) | trim }}"
  loop: "{{ consul_policies }}"
  loop_control:
    label: "{{ item.name }}"
  run_once: true
  delegate_to: "{{ consul_api_host }}"

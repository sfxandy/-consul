---
# Upsert policies via Consul HTTP API from consul_api_host

- name: Compute base URL, token and TLS params
  set_fact:
    _api_base: >-
      {{
        (consul_api_use_https | bool)
        | ternary('https://127.0.0.1:' ~ consul_https_port|string,
                  'http://127.0.0.1:8500')
      }}
    _gmt_eff: "{{ hostvars[consul_api_host].consul_mgmt_token_eff | default(consul_mgmt_token_eff_global) }}"
    _validate: "{{ (consul_api_use_https | bool) | ternary(true, false) }}"
  run_once: true
  delegate_to: "{{ consul_api_host }}"

- name: Assert policies + token available
  assert:
    that:
      - consul_policies | length > 0
      - (_gmt_eff | length) > 0
  run_once: true
  delegate_to: "{{ consul_api_host }}"

# 1) Read each policy by name (200 = exists, 404 = not found)
- name: Read policy by name
  uri:
    url: "{{ _api_base }}/v1/acl/policy/name/{{ item.name | urlencode }}"
    method: GET
    headers: { X-Consul-Token: "{{ _gmt_eff }}" }
    return_content: true
    status_code: [200, 404]
    validate_certs: "{{ _validate }}"
  register: _pol_read
  loop: "{{ consul_policies }}"
  loop_control: { label: "{{ item.name }}" }
  run_once: true
  delegate_to: "{{ consul_api_host }}"

# 2a) Create when not found (PUT /v1/acl/policy)
- name: Create policy (not found)
  uri:
    url: "{{ _api_base }}/v1/acl/policy"
    method: PUT
    headers: { X-Consul-Token: "{{ _gmt_eff }}" }
    body_format: json
    body:
      Name: "{{ item.item.name }}"
      Description: "{{ item.item.description | default(omit) }}"
      Rules: "{{ (lookup('file', item.item.file) | trim) }}"
    return_content: false
    status_code: [200]
    validate_certs: "{{ _validate }}"
  when: item.status == 404
  loop: "{{ _pol_read.results }}"
  loop_control: { label: "{{ item.item.name }}" }
  run_once: true
  delegate_to: "{{ consul_api_host }}"

# 2b) Update when found (need ID) â†’ PUT /v1/acl/policy/:id
- name: Update policy (exists)
  uri:
    url: "{{ _api_base }}/v1/acl/policy/{{ (item.json.ID) }}"
    method: PUT
    headers: { X-Consul-Token: "{{ _gmt_eff }}" }
    body_format: json
    body:
      ID: "{{ item.json.ID }}"
      Name: "{{ item.item.name }}"
      Description: "{{ item.item.description | default(omit) }}"
      Rules: "{{ (lookup('file', item.item.file) | trim) }}"
    return_content: false
    status_code: [200]
    validate_certs: "{{ _validate }}"
  when: item.status == 200
  loop: "{{ _pol_read.results }}"
  loop_control: { label: "{{ item.item.name }}" }
  run_once: true
  delegate_to: "{{ consul_api_host }}"

---
# Create/refresh Podman secrets per host (server + agent) without Galaxy modules.
# Reads token values from the consul_api_host's consul_agent_tokens_map.

- name: Ensure per-host secrets exist (server+agent)
  loop: "{{ groups['consul_hosts'] }}"
  loop_control:
    loop_var: tgt
    label: "{{ tgt }}"
  delegate_to: "{{ tgt }}"
  block:

    - name: Derive node + secret names for {{ tgt }}
      set_fact:
        _srv_node: "{{ hostvars[tgt].consul_server_node_name }}"
        _cli_node: "{{ hostvars[tgt].consul_client_node_name }}"
        _srv_secret: "consul_agent_token_{{ hostvars[tgt].consul_server_node_name }}"
        _cli_secret: "consul_agent_token_{{ hostvars[tgt].consul_client_node_name }}"

    # ----- Server secret -----
    - name: Check if server secret exists ({{ _srv_secret }})
      command: podman secret inspect {{ _srv_secret }}
      register: _srv_secret_inspect
      failed_when: false
      changed_when: false

    - name: Remove existing server secret ({{ _srv_secret }})
      command: podman secret rm {{ _srv_secret }}
      when: _srv_secret_inspect.rc == 0
      register: _srv_secret_rm
      changed_when: _srv_secret_rm.rc == 0

    - name: Create server secret ({{ _srv_secret }})
      shell: podman secret create {{ _srv_secret }} -
      args:
        stdin: "{{ hostvars[consul_api_host].consul_agent_tokens_map[_srv_node] }}"
      no_log: true
      register: _srv_secret_create
      changed_when: _srv_secret_create.rc == 0

    # ----- Agent secret -----
    - name: Check if client secret exists ({{ _cli_secret }})
      command: podman secret inspect {{ _cli_secret }}
      register: _cli_secret_inspect
      failed_when: false
      changed_when: false

    - name: Remove existing client secret ({{ _cli_secret }})
      command: podman secret rm {{ _cli_secret }}
      when: _cli_secret_inspect.rc == 0
      register: _cli_secret_rm
      changed_when: _cli_secret_rm.rc == 0

    - name: Create client secret ({{ _cli_secret }})
      shell: podman secret create {{ _cli_secret }} -
      args:
        stdin: "{{ hostvars[consul_api_host].consul_agent_tokens_map[_cli_node] }}"
      no_log: true
      register: _cli_secret_create
      changed_when: _cli_secret_create.rc == 0

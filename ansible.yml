- name: Derive status URLs + curl TLS args
  set_fact:
    _status_leader_url: >-
      {{
        (consul_api_use_https | bool)
        | ternary('https://127.0.0.1:' ~ consul_https_port ~ '/v1/status/leader',
                  'http://127.0.0.1:8500/v1/status/leader')
      }}
    _curl_tls: >-
      {{
        (consul_api_use_https | bool)
        | ternary('--cacert ' ~ consul_tls_ca_path, '')
      }}


- name: Wait for leader (status endpoint, tokenless)
  command: >
    podman exec {{ consul_server_container }} sh -lc
    "curl -fs {{ _curl_tls }} {{ _status_leader_url }} | grep -qE '\".+:[0-9]+\"'"
  register: _leader
  retries: 40
  delay: 3
  until: _leader.rc == 0






  - name: Verify leader exists (status endpoint)
  command: >
    podman exec {{ consul_server_container }} sh -lc
    "curl -fs {{ _curl_tls }} {{ _status_leader_url }} | grep -qE '\".+:[0-9]+\"'"
  register: _leader_check
  changed_when: false

- name: Assert leader exists
  assert:
    that: _leader_check.rc == 0
    fail_msg: "No leader from /v1/status/leader (curl failed or empty)."




- name: Server | wait for leader post-restart (status endpoint)
  command: >
    podman exec {{ consul_server_container }} sh -lc
    "curl -fs {{ _curl_tls }} {{ _status_leader_url }} | grep -qE '\".+:[0-9]+\"'"
  register: _leader_after_srv
  retries: 40
  delay: 3
  until: _leader_after_srv.rc == 0
  run_once: true
  delegate_to: "{{ consul_api_host }}"

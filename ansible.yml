---
# roles/consul_podman_acl_v3/tasks/mint_tokens.yml
# Mint per-node agent tokens (server + client) and publish a map on consul_api_host:
#   consul_agent_tokens_map: { <node_name>: <SecretID>, ... }

# Compute CLI env for HTTPS if enabled (runs on consul_api_host)
- name: Mint | compute CLI env
  set_fact:
    _cli_env: >-
      {{
        consul_api_use_https
        | ternary(
            {
              'CONSUL_HTTP_ADDR': 'https://127.0.0.1:' ~ (consul_https_port|string),
              'CONSUL_CACERT': consul_tls_ca_path,
              'CONSUL_CLIENT_CERT': consul_tls_client_cert,
              'CONSUL_CLIENT_KEY': consul_tls_client_key
            },
            { 'CONSUL_HTTP_ADDR': 'http://127.0.0.1:8500' }
          )
      }}
  run_once: true
  delegate_to: "{{ consul_api_host }}"

# Init token map (host fact on consul_api_host)
- name: Mint | init token map
  set_fact:
    consul_agent_tokens_map: {}
  run_once: true
  delegate_to: "{{ consul_api_host }}"
  delegate_facts: true

# Derive server node names for each target host
- name: Mint | derive server node names
  set_fact:
    _srv_node: "{{ hostvars[item].consul_server_node_name }}"
  loop: "{{ groups['consul_hosts'] }}"
  loop_control: { label: "{{ item }}" }
  run_once: true
  delegate_to: "{{ consul_api_host }}"

# Derive client node names for each target host
- name: Mint | derive client node names
  set_fact:
    _cli_node: "{{ hostvars[item].consul_client_node_name }}"
  loop: "{{ groups['consul_hosts'] }}"
  loop_control: { label: "{{ item }}" }
  run_once: true
  delegate_to: "{{ consul_api_host }}"

# Create token for each SERVER node
- name: Mint | create token (server nodes)
  vars:
    _gmt: "{{ hostvars[consul_api_host].consul_mgmt_token_eff | default(consul_mgmt_token_eff_global) }}"
    _srv_node: "{{ hostvars[item].consul_server_node_name }}"
  command: >
    podman exec
    {% for k,v in _cli_env.items() %} -e {{ k }}={{ v }} {% endfor %}
    {{ consul_server_container }}
    consul acl token create
    -description "Agent token for {{ _srv_node }}"
    -policy-name {{ consul_policy_server_name | quote }}
    -format=json
    -token {{ _gmt }}
  register: _t_srv
  changed_when: true
  loop: "{{ groups['consul_hosts'] }}"
  loop_control: { label: "{{ item }} → {{ _srv_node }}" }
  run_once: true
  delegate_to: "{{ consul_api_host }}"

# Record each SERVER token into the map
- name: Mint | record server tokens
  set_fact:
    consul_agent_tokens_map: "{{ consul_agent_tokens_map | combine({ (hostvars[item.item].consul_server_node_name): ((item.stdout | from_json).SecretID) }) }}"
  loop: "{{ _t_srv.results }}"
  loop_control: { label: "{{ item.item }} → {{ hostvars[item.item].consul_server_node_name }}" }
  run_once: true
  delegate_to: "{{ consul_api_host }}"
  delegate_facts: true
  no_log: true

# Create token for each CLIENT node
- name: Mint | create token (client nodes)
  vars:
    _gmt: "{{ hostvars[consul_api_host].consul_mgmt_token_eff | default(consul_mgmt_token_eff_global) }}"
    _cli_node: "{{ hostvars[item].consul_client_node_name }}"
  command: >
    podman exec
    {% for k,v in _cli_env.items() %} -e {{ k }}={{ v }} {% endfor %}
    {{ consul_server_container }}
    consul acl token create
    -description "Agent token for {{ _cli_node }}"
    -policy-name {{ consul_policy_client_name | quote }}
    -format=json
    -token {{ _gmt }}
  register: _t_cli
  changed_when: true
  loop: "{{ groups['consul_hosts'] }}"
  loop_control: { label: "{{ item }} → {{ _cli_node }}" }
  run_once: true
  delegate_to: "{{ consul_api_host }}"

# Record each CLIENT token into the map
- name: Mint | record client tokens
  set_fact:
    consul_agent_tokens_map: "{{ consul_agent_tokens_map | combine({ (hostvars[item.item].consul_client_node_name): ((item.stdout | from_json).SecretID) }) }}"
  loop: "{{ _t_cli.results }}"
  loop_control: { label: "{{ item.item }} → {{ hostvars[item.item].consul_client_node_name }}" }
  run_once: true
  delegate_to: "{{ consul_api_host }}"
  delegate_facts: true
  no_log: true

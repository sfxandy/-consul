---
# Rolling restart after rendering ACL overlay so all instances pick up ACLs

# Helper: wait until a leader exists (runs against consul_api_host)
- name: Wait for Raft leader (grep)
  command: >
    podman exec
    {{ consul_server_container }}
    sh -lc "consul operator raft list-peers | tail -n +2 | awk '{print $3}' | grep -iq '^leader$'"
  register: _leader_check
  retries: 40
  delay: 3
  until: _leader_check.rc == 0
  run_once: true
  delegate_to: "{{ consul_api_host }}"

# Restart servers one-by-one
- name: Rolling restart | servers
  vars:
    _chdir: "{{ compose_repo_root }}"
  loop: "{{ groups['consul_hosts'] }}"
  loop_control: { loop_var: tgt }
  block:
    - name: Server | stop
      command: podman-compose -f {{ compose_repo_compose }} stop consul-server
      args: { chdir: "{{ _chdir }}" }
      delegate_to: "{{ tgt }}"
      register: _stop_srv
      failed_when: false
      changed_when: _stop_srv.rc == 0

    - name: Server | up
      command: podman-compose -f {{ compose_repo_compose }} up -d consul-server
      args: { chdir: "{{ _chdir }}" }
      delegate_to: "{{ tgt }}"
      register: _up_srv
      changed_when: _up_srv.rc == 0

    # Verify cluster still has a leader after each server restart
    - name: Server | wait for leader post-restart
      command: >
        podman exec
        {{ consul_server_container }}
        sh -lc "consul operator raft list-peers | tail -n +2 | awk '{print $3}' | grep -iq '^leader$'"
      register: _leader_after_srv
      retries: 40
      delay: 3
      until: _leader_after_srv.rc == 0
      run_once: true
      delegate_to: "{{ consul_api_host }}"

# Restart agents one-by-one (same hosts)
- name: Rolling restart | agents
  vars:
    _chdir: "{{ compose_repo_root }}"
  loop: "{{ groups['consul_hosts'] }}"
  loop_control: { loop_var: tgt }
  block:
    - name: Agent | stop
      command: podman-compose -f {{ compose_repo_compose }} stop consul-agent
      args: { chdir: "{{ _chdir }}" }
      delegate_to: "{{ tgt }}"
      register: _stop_cli
      failed_when: false
      changed_when: _stop_cli.rc == 0

    - name: Agent | up
      command: podman-compose -f {{ compose_repo_compose }} up -d consul-agent
      args: { chdir: "{{ _chdir }}" }
      delegate_to: "{{ tgt }}"
      register: _up_cli
      changed_when: _up_cli.rc == 0

    # Light sanity: agent is up and consul CLI runs
    - name: Agent | consul info check
      command: podman exec {{ consul_client_container }} consul info
      delegate_to: "{{ tgt }}"
      register: _cli_info
      retries: 20
      delay: 2
      until: _cli_info.rc == 0

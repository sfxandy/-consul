
---
# Build a flat list of secrets to (re)create, then handle each with include_tasks.

- name: Init secret items
  set_fact:
    _secret_items: []
  run_once: true

- name: Collect per-host secret items (server + agent)
  set_fact:
    _secret_items: "{{ _secret_items + [
      {
        'host': item,
        'node': hostvars[item].consul_server_node_name,
        'secret_name': 'consul_agent_token_' ~ hostvars[item].consul_server_node_name
      },
      {
        'host': item,
        'node': hostvars[item].consul_client_node_name,
        'secret_name': 'consul_agent_token_' ~ hostvars[item].consul_client_node_name
      }
    ] }}"
  loop: "{{ groups['consul_hosts'] }}"
  run_once: true

- name: Ensure Podman secrets exist (server + agent per host)
  include_tasks: secrets_one.yml
  loop: "{{ _secret_items }}"
  loop_control:
    label: "{{ item.host }} -> {{ item.secret_name }}"











---
# Expects item = { host, node, secret_name }
# Reads token value from consul_api_host's consul_agent_tokens_map[item.node]

- name: Lookup token value for {{ item.node }}
  set_fact:
    _secret_value: "{{ hostvars[consul_api_host].consul_agent_tokens_map[item.node] | default('') }}"
  no_log: true
  run_once: true

- name: Assert token value present for {{ item.node }}
  assert:
    that: _secret_value | length > 0
    fail_msg: "No token found for node {{ item.node }} in consul_agent_tokens_map on {{ consul_api_host }}."
  run_once: true

- name: Check if secret exists ({{ item.secret_name }})
  command: podman secret inspect {{ item.secret_name }}
  register: _inspect
  failed_when: false
  changed_when: false
  delegate_to: "{{ item.host }}"

- name: Remove existing secret ({{ item.secret_name }})
  command: podman secret rm {{ item.secret_name }}
  when: _inspect.rc == 0
  register: _rm
  changed_when: _rm.rc == 0
  delegate_to: "{{ item.host }}"

- name: Create secret ({{ item.secret_name }}) from stdin
  shell: podman secret create {{ item.secret_name }} -
  args:
    stdin: "{{ _secret_value }}"
  no_log: true
  register: _create
  changed_when: _create.rc == 0
  delegate_to: "{{ item.host }}"
